# /opt/local/share/dnscrypt-proxy/dnscrypt-proxy.toml

##############################################
#        Global settings                     #
##############################################

# Unbound upstream addresses
listen_addresses = ['127.0.0.1:54', '[::1]:54']

# Maximum concurrent client connections
max_clients = 250


##############################################
#        Server Selection                    #
##############################################

# Use servers reachable over IPv4 only (IPv6 can leak)
ipv4_servers = true
ipv6_servers = false

# DNSCrypt only (better anonymization support than DoH)
dnscrypt_servers = true
doh_servers = false
odoh_servers = false

# Server requirements
require_dnssec = true
require_nolog = true
require_nofilter = true

server_names = [
    # === Cryptostorm European servers ===
    'cs-de',
    'cs-dus',
    'cs-berlin',
    'cs-nl',
    'cs-belgium',
    'cs-fr',
    'cs-ch',
    
    # UK & Ireland
    'cs-london',
    'cs-manchester',
    
    # Southern Europe
    'cs-barcelona',
    'cs-pt',
    'cs-milan',
    
    # Northern Europe
    'cs-swe',
    'cs-norway',
    'cs-finland',
    
    # Central/Eastern Europe
    'cs-austria',
    'cs-czech',
    'cs-poland',
    'cs-hungary',
    'cs-ro',
    'cs-serbia',
    'cs-md',
    
    # === Other European DNSCrypt servers ===
    'dct-de',
    'dct-fr',
    'digitalprivacy.diy-dnscrypt-ipv4'
]

# Disable servers whose operators also run relays
# Since this config use cs-* servers, do not use cs-* relays (operator correlation)
# The servers below run both servers AND relays - disable them
disabled_server_names = [
    # CleanBrowsing
    'cleanbrowsing-adult', 'cleanbrowsing-family', 'cleanbrowsing-security',
    
    # Scaleway
    'scaleway-fr', 'scaleway-ams',
    
    # DNSCrypt.uk
    'dnscrypt.uk-ipv4', 'dnscrypt.uk-ipv6',
    'v.dnscrypt.uk-ipv4', 'v.dnscrypt.uk-ipv6'
]


##############################################
#        Connection Settings                 #
##############################################

# UDP preferred (faster), TCP as fallback
force_tcp = false

# Disable experimental HTTP/3
http3 = false

# Increased timeout for relay paths (ms)
timeout = 5000

# Keep connections alive (seconds)
keepalive = 60

# Mullvad integration: uncomment to DNS through the tunnel
# proxy = 'socks5://127.0.0.1:1080'


##############################################
#        Load Balancing                      #
##############################################

# Use fastest 3 servers from your European list, randomize between them
# Increased from p2 to p3 for better distribution
lb_strategy = 'p3'

# Continuously estimate latency
lb_estimator = true


##############################################
#        Logging (minimal for privacy)       #
##############################################

# Log level: 0=verbose, 6=fatal only
log_level = 2

# Use system logger
use_syslog = true

# Log rotation
log_files_max_size = 10
log_files_max_age = 7
log_files_max_backups = 1


##############################################
#        Certificate Management              #
##############################################

# How often to refresh DNSCrypt certificates (minutes)
cert_refresh_delay = 240

# Reject certificates with future timestamps
cert_ignore_timestamp = false

# Create new key pair for every query (critical for privacy)
dnscrypt_ephemeral_keys = true

# Disable TLS session tickets (prevents tracking)
tls_disable_session_tickets = true


##############################################
#        Startup & Network                   #
##############################################

# Bootstrap resolvers (only used for initial setup, never for actual queries)
bootstrap_resolvers = ['9.9.9.9:53', '1.1.1.1:53', '8.8.8.8:53']

# Never fall back to system DNS
ignore_system_dns = true

# Wait for network at startup (seconds)
netprobe_timeout = 60

# Address to probe for connectivity
netprobe_address = '9.9.9.9:53'


##############################################
#        Filters                             #
##############################################

# Don't block IPv6 responses
block_ipv6 = false

# Block queries for unqualified names (prevents leaks)
block_unqualified = true

# Block queries for undelegated zones (prevents leaks)
block_undelegated = true

# TTL for blocked responses
reject_ttl = 10


##############################################
#        DNS Cache                           #
##############################################

cache = true
cache_size = 4096
cache_min_ttl = 2400
cache_max_ttl = 86400
cache_neg_min_ttl = 60
cache_neg_max_ttl = 600


##############################################
#        Captive Portals                     #
##############################################

[captive_portals]
# Disabled - handle manually if needed


##############################################
#        Local DoH Server                    #
##############################################

[local_doh]
# Disabled - not needed with Unbound setup


##############################################
#        Query Logging                       #
##############################################

[query_log]
# Disabled for privacy - uncomment only for debugging
# file = '/var/log/dnscrypt-proxy/query.log'
format = 'tsv'


##############################################
#        NX Logging                          #
##############################################

[nx_log]
# Disabled for privacy
format = 'tsv'


##############################################
#        Blocklists                          #
##############################################

# Not needed - using Steven Black hosts in /etc/hosts

[blocked_names]
# blocked_names_file = 'blocked-names.txt'

[blocked_ips]
# blocked_ips_file = 'blocked-ips.txt'

[allowed_names]
# allowed_names_file = 'allowed-names.txt'

[allowed_ips]
# allowed_ips_file = 'allowed-ips.txt'


##############################################
#        Schedules                           #
##############################################

[schedules]
# No time-based restrictions


##############################################
#        Server Sources                      #
##############################################

[sources]

  [sources.public-resolvers]
    urls = [
      'https://raw.githubusercontent.com/DNSCrypt/dnscrypt-resolvers/master/v3/public-resolvers.md',
      'https://download.dnscrypt.info/resolvers-list/v3/public-resolvers.md'
    ]
    cache_file = 'public-resolvers.md'
    minisign_key = 'RWQf6LRCGA9i53mlYecO4IzT51TGPpvWucNSCh1CBM0QTaLn73Y7GFO3'
    refresh_delay = 72
    prefix = ''

  [sources.relays]
    urls = [
      'https://raw.githubusercontent.com/DNSCrypt/dnscrypt-resolvers/master/v3/relays.md',
      'https://download.dnscrypt.info/resolvers-list/v3/relays.md'
    ]
    cache_file = 'relays.md'
    minisign_key = 'RWQf6LRCGA9i53mlYecO4IzT51TGPpvWucNSCh1CBM0QTaLn73Y7GFO3'
    refresh_delay = 72
    prefix = ''


##############################################
#        Broken Implementations              #
##############################################

[broken_implementations]

fragments_blocked = [
    'cisco', 'cisco-ipv6', 'cisco-familyshield', 'cisco-familyshield-ipv6',
    'cleanbrowsing-adult', 'cleanbrowsing-family', 'cleanbrowsing-security'
]


##############################################
#        DoH Client Auth                     #
##############################################

[doh_client_x509_auth]
# Not used - DNSCrypt only


##############################################
#        Anonymized DNS                      #
##############################################

[anonymized_dns]

# CRITICAL: Relays must be from DIFFERENT operators than servers!
# Since we primarily use cs-* (cryptostorm) servers,
# we use NON-cryptostorm European relays here.

routes = [
    { server_name = '*', via = [
        # === DNSCry.pt relays (European locations, different operator) ===
        'dnscry.pt-anon-amsterdam-ipv4',
        'dnscry.pt-anon-zurich-ipv4',
        'dnscry.pt-anon-frankfurt-ipv4',
        'dnscry.pt-anon-london-ipv4',
        'dnscry.pt-anon-paris-ipv4',
        'dnscry.pt-anon-milan-ipv4',
        'dnscry.pt-anon-stockholm02-ipv4',
        
        # === Scaleway relays (Frank Denis/jedisct1, France & Amsterdam) ===
        'anon-scaleway',
        'anon-scaleway-ams',
        'anon-scaleway2',
        
        # === Other European relays (all different operators) ===
        'anon-kama',
        'anon-ibksturm',
        'anon-dnswarden-swiss',
        'anon-dnscrypt.uk-ipv4', 
        'anon-v.dnscrypt.uk-ipv4',
        'anon-serbica',
        'anon-digitalprivacy.diy-ipv4'
    ]}
]

# Allow incompatible servers with direct fallback
skip_incompatible = false

# Allow direct cert fetch if relay fails
direct_cert_fallback = true


##############################################
#        DNS64                               #
##############################################

[dns64]
# Disabled -- not using NAT64


##############################################
#        IP Encryption                       #
##############################################

[ip_encryption]
# Disabled -- no logging anyway
algorithm = "none"
key = ""


##############################################
#        Monitoring UI                       #
##############################################

[monitoring_ui]
# Disabled -- reduces attack surface
enabled = false


##############################################
#        Static Entries                      #
##############################################

[static]
# No custom servers
