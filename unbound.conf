# /opt/local/etc/unbound/unbound.conf
# Hardened configuration - Security/Privacy focused

server:
    # ============================================================
    # LISTENER CONFIGURATION
    # ============================================================
    interface: 127.0.0.1
    interface: ::1
    port: 53
    do-ip4: yes
    do-ip6: yes
    do-udp: yes
    do-tcp: yes
    
    # Bind to specific interfaces only (equivalent to dnsmasq listen-address)
    interface-automatic: no
    
    # ============================================================
    # ACCESS CONTROL
    # ============================================================
    access-control: 127.0.0.0/8 allow
    access-control: ::1 allow
    access-control: 0.0.0.0/0 refuse
    access-control: ::0/0 refuse
    
    # ============================================================
    # CACHE SETTINGS
    # ============================================================
    # Minimum TTL - don't cache less than this (prevents rapid re-queries)
    # 2400s = 40 minutes; balances freshness with privacy (fewer queries upstream)
    cache-min-ttl: 2400
    
    # Maximum TTL cap (1 day)
    cache-max-ttl: 86400
    
    # Negative response caching (NXDOMAIN/NODATA)
    cache-max-negative-ttl: 3600
    
    # ============================================================
    # SERVE EXPIRED (Resilience/Availability)
    # ============================================================
    # Serve stale data while refreshing - improves resilience
    serve-expired: yes
    serve-expired-ttl: 86400
    serve-expired-reply-ttl: 30
    serve-expired-client-timeout: 1800
    
    # Don't reset TTL of expired records (more accurate behavior)
    serve-expired-ttl-reset: no
    
    # ============================================================
    # CACHE SIZES
    # ============================================================
    # Slightly increased for better hit rates
    # dnsmasq had cache-size=2000; Unbound's msg-cache is more efficient
    msg-cache-size: 64m
    rrset-cache-size: 128m
    neg-cache-size: 16m
    
    # ============================================================
    # DNSSEC VALIDATION
    # ============================================================
    module-config: "validator iterator"
    auto-trust-anchor-file: "/opt/local/etc/unbound/root.key"
    
    # Clean additional section of insecure data
    val-clean-additional: yes
    
    # Strict DNSSEC - don't fall back to insecure on stripped DNSSEC
    val-permissive-mode: no
    
    # Log DNSSEC validation failures (1 = per-query, 2 = detailed)
    val-log-level: 1
    
    # Trust anchor signaling (RFC 8145) - helps with key rollovers
    trust-anchor-signaling: yes
    
    # Root key sentinel - detects root key rollovers
    root-key-sentinel: yes
    
    # Stricter signature verification
    # Note: val-sig-skew-min/max left at defaults (3600/86400) for compatibility
    
    # ============================================================
    # DNS REBINDING PROTECTION (equivalent to dnsmasq stop-dns-rebind)
    # ============================================================
    # RFC 1918 private addresses
    private-address: 10.0.0.0/8
    private-address: 172.16.0.0/12
    private-address: 192.168.0.0/16
    
    # Link-local
    private-address: 169.254.0.0/16
    
    # IPv6 ULA and link-local
    private-address: fd00::/8
    private-address: fe80::/10
    
    # Loopback
    private-address: 127.0.0.0/8
    private-address: ::1/128
    
    # IPv4-mapped IPv6 addresses (bypass prevention)
    private-address: ::ffff:0:0/96
    
    # Carrier-grade NAT / Shared Address Space (RFC 6598)
    private-address: 100.64.0.0/10
    
    # Benchmark testing (RFC 2544)
    private-address: 198.18.0.0/15
    
    # Documentation ranges (RFC 5737)
    private-address: 192.0.2.0/24
    private-address: 198.51.100.0/24
    private-address: 203.0.113.0/24
    
    # "This" network
    private-address: 0.0.0.0/8
    
    # Reserved for future use
    private-address: 240.0.0.0/4
    
    # Broadcast
    private-address: 255.255.255.255/32
    
    # IPv6 documentation (RFC 3849)
    private-address: 2001:db8::/32
    
    # IPv6 deprecated site-local
    private-address: fec0::/10
    
    # ============================================================
    # REBIND LOCALHOST EXCEPTION (equivalent to dnsmasq rebind-localhost-ok)
    # ============================================================
    private-domain: "localhost."
    private-domain: "127.in-addr.arpa."
    private-domain: "1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa."
    
    # ============================================================
    # DNSSEC HARDENING
    # ============================================================
    # Require DNSSEC for trust-anchored zones
    harden-dnssec-stripped: yes
    
    # RFC 8020 - NXDOMAIN means nothing underneath
    harden-below-nxdomain: yes
    
    # Trust only in-zone glue
    harden-glue: yes
    
    # Reject very large queries (potential attack vector)
    harden-large-queries: yes
    
    # Reject very small EDNS buffer sizes
    harden-short-bufsize: yes
    
    # Reject unknown record types in additional section
    harden-unknown-additional: yes
    
    # Algorithm downgrade protection (may break some non-compliant zones)
    # Disabled by default per RFC 6840 - enable if you want stricter checks
    harden-algo-downgrade: no
    
    # Referral path hardening - experimental, can cause performance issues
    # Disabled for battery life consideration
    harden-referral-path: no
    
    # ============================================================
    # QUERY NAME RANDOMIZATION (0x20 encoding)
    # ============================================================
    # Foil spoof attempts by randomizing case in queries
    use-caps-for-id: yes
    
    # Exempt problematic domains that don't preserve case
    # Add domains here if you encounter issues
    # caps-exempt: "example.com"
    
    # ============================================================
    # ANTI-SPOOFING / ANTI-POISONING
    # ============================================================
    # Deny queries of type ANY (reduces amplification attacks)
    deny-any: yes
    
    # Unwanted reply threshold - clears cache if threshold reached
    # Defends against cache poisoning (10 million as per manpage)
    unwanted-reply-threshold: 10000000
    
    # DNS Cookies (RFC 7873, RFC 9018) - prevents spoofing
    answer-cookie: yes
    
    # UDP connect - mitigates ICMP side channel leakage
    udp-connect: yes
    
    # Drop old UDP queries that waited too long in socket buffer
    sock-queue-timeout: 3
    
    # Discard timeout - drop queries that take too long to resolve
    discard-timeout: 1900
    
    # ============================================================
    # EDNS SETTINGS (DNS Flag Day 2020)
    # ============================================================
    edns-buffer-size: 1232
    max-udp-size: 1232
    
    # ============================================================
    # OUTBOUND PORT RANDOMIZATION
    # ============================================================
    outgoing-port-permit: 1024-65535
    outgoing-port-avoid: 0-1023
    
    # ============================================================
    # LOCALHOST QUERIES (required for dnscrypt-proxy forwarding)
    # ============================================================
    do-not-query-localhost: no
    
    # ============================================================
    # PRIVACY FEATURES
    # ============================================================
    # QNAME minimisation (RFC 7816) - send minimal info to upstreams
    qname-minimisation: yes
    
    # Non-strict mode - falls back on errors for compatibility
    qname-minimisation-strict: no
    
    # Aggressive NSEC (RFC 8198) - synthesize NXDOMAIN from NSEC
    aggressive-nsec: yes
    
    # Hide server identity
    hide-identity: yes
    hide-version: yes
    hide-trustanchor: yes
    identity: "DNS"
    
    # Minimal responses - don't include unnecessary sections
    minimal-responses: yes
    
    # ============================================================
    # ITERATOR SCRUBBING (Anti-poisoning)
    # ============================================================
    # Limit NS records per rrset (protects against oversized NS sets)
    iter-scrub-ns: 20
    
    # Limit CNAME chain length
    iter-scrub-cname: 11
    
    # Remove promiscuous NS from positive answers
    iter-scrub-promiscuous: yes
    
    # ============================================================
    # QUERY LIMITS (DoS protection)
    # ============================================================
    # Maximum outgoing queries per resolution
    max-sent-count: 32
    
    # Maximum CNAME chain restarts
    max-query-restarts: 11
    
    # Global query quota per incoming query
    max-global-quota: 200
    
    # Retry limit per upstream
    outbound-msg-retry: 5
    
    # ============================================================
    # RATE LIMITING
    # ============================================================
    # Ratelimit queries to nameservers (qps) - prevents recursive floods
    # 0 = disabled; set to ~1000 for active protection
    ratelimit: 1000
    ratelimit-size: 4m
    ratelimit-factor: 10
    
    # IP-based ratelimit for incoming queries
    # Clients with valid DNS Cookies bypass this
    ip-ratelimit: 1000
    ip-ratelimit-size: 4m
    ip-ratelimit-factor: 10
    
    # ============================================================
    # PERFORMANCE (balanced for battery life)
    # ============================================================
    num-threads: 2
    
    # Slabs should be power of 2 close to num-threads
    msg-cache-slabs: 4
    rrset-cache-slabs: 4
    infra-cache-slabs: 4
    key-cache-slabs: 4
    
    # Socket options
    so-reuseport: yes
    so-rcvbuf: 4m
    so-sndbuf: 4m
    
    # Prefetch popular items before they expire
    # Slight increase in traffic but keeps popular items fresh
    prefetch: yes
    prefetch-key: yes
    
    # Rotate RRset order (load balancing)
    rrset-roundrobin: yes
    
    # Queries per thread
    num-queries-per-thread: 4096
    outgoing-range: 8192
    
    # TCP connection handling
    incoming-num-tcp: 100
    outgoing-num-tcp: 100
    
    # Delay for timeouted UDP ports
    delay-close: 10000
    
    # Infrastructure cache
    infra-cache-numhosts: 10000
    infra-keep-probing: yes
    
    # Unknown server timeout (increase for slow links)
    unknown-server-time-limit: 376
    
    # ============================================================
    # LOCAL ZONES - TLD BLOCKING
    # ============================================================
    # Standard non-routable TLDs
    local-zone: "local." static
    local-zone: "localhost." static
    local-zone: "home." static
    local-zone: "lan." static
    local-zone: "internal." static
    local-zone: "corp." static
    local-zone: "private." static
    
    # RFC 6761 special-use domains
    local-zone: "test." static
    local-zone: "invalid." static
    
    # RFC 7686 - Tor hidden services (prevent leakage)
    local-zone: "onion." static
    
    # RFC 8375 - Home networks
    local-zone: "home.arpa." static
    
    # Prevent leakage of local hostnames (equivalent to dnsmasq domain-needed behavior)
    local-zone: "intranet." static
    local-zone: "internal." static
    local-zone: "workgroup." static
    local-zone: "localdomain." static
    
    # ============================================================
    # BOGUS PRIVATE REVERSE LOOKUPS (equivalent to dnsmasq bogus-priv)
    # ============================================================
    # RFC 1918 reverse zones
    local-zone: "10.in-addr.arpa." static
    local-zone: "16.172.in-addr.arpa." static
    local-zone: "17.172.in-addr.arpa." static
    local-zone: "18.172.in-addr.arpa." static
    local-zone: "19.172.in-addr.arpa." static
    local-zone: "20.172.in-addr.arpa." static
    local-zone: "21.172.in-addr.arpa." static
    local-zone: "22.172.in-addr.arpa." static
    local-zone: "23.172.in-addr.arpa." static
    local-zone: "24.172.in-addr.arpa." static
    local-zone: "25.172.in-addr.arpa." static
    local-zone: "26.172.in-addr.arpa." static
    local-zone: "27.172.in-addr.arpa." static
    local-zone: "28.172.in-addr.arpa." static
    local-zone: "29.172.in-addr.arpa." static
    local-zone: "30.172.in-addr.arpa." static
    local-zone: "31.172.in-addr.arpa." static
    local-zone: "168.192.in-addr.arpa." static
    
    # Link-local reverse
    local-zone: "254.169.in-addr.arpa." static
    
    # IPv6 private reverse zones
    local-zone: "d.f.ip6.arpa." static
    local-zone: "8.e.f.ip6.arpa." static
    local-zone: "9.e.f.ip6.arpa." static
    local-zone: "a.e.f.ip6.arpa." static
    local-zone: "b.e.f.ip6.arpa." static
    
    # Carrier-grade NAT reverse (RFC 6598)
    local-zone: "64.100.in-addr.arpa." static
    local-zone: "65.100.in-addr.arpa." static
    local-zone: "66.100.in-addr.arpa." static
    local-zone: "67.100.in-addr.arpa." static
    local-zone: "68.100.in-addr.arpa." static
    local-zone: "69.100.in-addr.arpa." static
    local-zone: "70.100.in-addr.arpa." static
    local-zone: "71.100.in-addr.arpa." static
    local-zone: "72.100.in-addr.arpa." static
    local-zone: "73.100.in-addr.arpa." static
    local-zone: "74.100.in-addr.arpa." static
    local-zone: "75.100.in-addr.arpa." static
    local-zone: "76.100.in-addr.arpa." static
    local-zone: "77.100.in-addr.arpa." static
    local-zone: "78.100.in-addr.arpa." static
    local-zone: "79.100.in-addr.arpa." static
    local-zone: "80.100.in-addr.arpa." static
    local-zone: "81.100.in-addr.arpa." static
    local-zone: "82.100.in-addr.arpa." static
    local-zone: "83.100.in-addr.arpa." static
    local-zone: "84.100.in-addr.arpa." static
    local-zone: "85.100.in-addr.arpa." static
    local-zone: "86.100.in-addr.arpa." static
    local-zone: "87.100.in-addr.arpa." static
    local-zone: "88.100.in-addr.arpa." static
    local-zone: "89.100.in-addr.arpa." static
    local-zone: "90.100.in-addr.arpa." static
    local-zone: "91.100.in-addr.arpa." static
    local-zone: "92.100.in-addr.arpa." static
    local-zone: "93.100.in-addr.arpa." static
    local-zone: "94.100.in-addr.arpa." static
    local-zone: "95.100.in-addr.arpa." static
    local-zone: "96.100.in-addr.arpa." static
    local-zone: "97.100.in-addr.arpa." static
    local-zone: "98.100.in-addr.arpa." static
    local-zone: "99.100.in-addr.arpa." static
    local-zone: "100.100.in-addr.arpa." static
    local-zone: "101.100.in-addr.arpa." static
    local-zone: "102.100.in-addr.arpa." static
    local-zone: "103.100.in-addr.arpa." static
    local-zone: "104.100.in-addr.arpa." static
    local-zone: "105.100.in-addr.arpa." static
    local-zone: "106.100.in-addr.arpa." static
    local-zone: "107.100.in-addr.arpa." static
    local-zone: "108.100.in-addr.arpa." static
    local-zone: "109.100.in-addr.arpa." static
    local-zone: "110.100.in-addr.arpa." static
    local-zone: "111.100.in-addr.arpa." static
    local-zone: "112.100.in-addr.arpa." static
    local-zone: "113.100.in-addr.arpa." static
    local-zone: "114.100.in-addr.arpa." static
    local-zone: "115.100.in-addr.arpa." static
    local-zone: "116.100.in-addr.arpa." static
    local-zone: "117.100.in-addr.arpa." static
    local-zone: "118.100.in-addr.arpa." static
    local-zone: "119.100.in-addr.arpa." static
    local-zone: "120.100.in-addr.arpa." static
    local-zone: "121.100.in-addr.arpa." static
    local-zone: "122.100.in-addr.arpa." static
    local-zone: "123.100.in-addr.arpa." static
    local-zone: "124.100.in-addr.arpa." static
    local-zone: "125.100.in-addr.arpa." static
    local-zone: "126.100.in-addr.arpa." static
    local-zone: "127.100.in-addr.arpa." static
    
    # ============================================================
    # LOGGING
    # ============================================================
    verbosity: 1
    use-syslog: yes
    
    # Query/reply logging (disabled for privacy - enable for debugging)
    # Equivalent to dnsmasq log-queries but disabled by default
    log-queries: no
    log-replies: no
    
    # Log SERVFAIL reasons (useful for troubleshooting)
    log-servfail: yes
    
    # Log local zone actions (disabled for performance)
    log-local-actions: no
    
    # ============================================================
    # EXTENDED DNS ERROR CODES (RFC 8914)
    # ============================================================
    ede: yes
    ede-serve-expired: yes

# ============================================================
# FORWARDING TO DNSCRYPT-PROXY
# ============================================================
forward-zone:
    name: "."
    forward-addr: 127.0.0.1@54
    forward-addr: ::1@54
    # Don't try to resolve directly if forwarder fails
    forward-first: no

# ============================================================
# REMOTE CONTROL (disabled for security)
# ============================================================
remote-control:
    control-enable: no
