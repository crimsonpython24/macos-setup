# /opt/local/etc/unbound/unbound.conf

server:
    # listener config
    interface: 127.0.0.1
    interface: ::1
    port: 53
    do-ip4: yes
    do-ip6: yes
    do-udp: yes
    do-tcp: yes
    
    # bind to specific interfaces only
    interface-automatic: no
    
    # access control
    access-control: 127.0.0.0/8 allow
    access-control: ::1 allow
    access-control: 0.0.0.0/0 refuse
    access-control: ::0/0 refuse
    
    # cache settings
    cache-min-ttl: 2400
    cache-max-ttl: 86400
    cache-max-negative-ttl: 3600
    
    # serve expired entries while refreshing (resilience)
    serve-expired: yes
    serve-expired-ttl: 86400
    serve-expired-reply-ttl: 30
    serve-expired-client-timeout: 1800
    
    # cache sizes (slightly increased from original)
    msg-cache-size: 64m
    rrset-cache-size: 128m
    neg-cache-size: 16m
    
    # DNSSEC
    module-config: "validator iterator"
    auto-trust-anchor-file: "/opt/local/etc/unbound/root.key"
    val-clean-additional: yes
    val-permissive-mode: no
    val-log-level: 1
    
    # trust anchor signaling (RFC 8145)
    trust-anchor-signaling: yes
    
    # root key sentinel (detects root key rollovers)
    root-key-sentinel: yes
    
    # dns rebinding protection
    private-address: 10.0.0.0/8
    private-address: 172.16.0.0/12
    private-address: 192.168.0.0/16
    private-address: 169.254.0.0/16
    private-address: fd00::/8
    private-address: fe80::/10
    private-address: 127.0.0.0/8
    private-address: ::1/128

    # block IPv4-mapped IPv6 addresses (bypass prevention)
    private-address: ::ffff:0:0/96
    
    # allow localhost queries (rebind-localhost-ok equivalent)
    private-domain: "localhost."
    private-domain: "127.in-addr.arpa."
    
    # DNSSEC hardening
    harden-algo-downgrade: yes
    harden-below-nxdomain: yes
    harden-dnssec-stripped: yes
    harden-glue: yes
    harden-large-queries: yes
    harden-referral-path: no  # Changed: experimental, can cause performance issues
    harden-short-bufsize: yes
    harden-unknown-additional: yes  # NEW: reject unknown record types in additional section
    
    # 0x20-encoded random bits to foil spoof attempts
    use-caps-for-id: yes
    
    # deny queries of type ANY (reduces amplification attacks)
    deny-any: yes
    
    # unwanted reply threshold: defend against cache poisoning
    # clears cache if threshold reached (10 million suggested by manpage)
    unwanted-reply-threshold: 10000000
    
    # EDNS buffer size (DNS Flag Day 2020)
    edns-buffer-size: 1232
    max-udp-size: 1232
    
    # outbound port range w/ source port randomization
    outgoing-port-permit: 1024-65535
    outgoing-port-avoid: 0-1023
    
    # do not query localhost
    do-not-query-localhost: no
    
    # privacy features
    qname-minimisation: yes
    qname-minimisation-strict: no
    aggressive-nsec: yes
    hide-identity: yes
    hide-version: yes
    hide-trustanchor: yes 
    identity: "DNS"  
    minimal-responses: yes
    
    # performance?
    num-threads: 2
    
    # slabs should be power of 2 close to num-threads
    msg-cache-slabs: 4
    rrset-cache-slabs: 4
    infra-cache-slabs: 4
    key-cache-slabs: 4
    
    # socket options (increase send/recv buffer)
    so-reuseport: yes
    so-rcvbuf: 4m  
    so-sndbuf: 4m  
    
    # prefetch popular items before they expire
    prefetch: yes
    prefetch-key: yes
    
    # rotate RRset order in responses (load balancing)
    rrset-roundrobin: yes
    
    # number of queries per thread
    num-queries-per-thread: 4096
    outgoing-range: 8192
    
    # TCP connection handling
    incoming-num-tcp: 100
    outgoing-num-tcp: 100
    
    # extra delay for timeouted udp ports (prevents port counter issues)
    delay-close: 10000
    
    # infra-cache settings
    infra-cache-numhosts: 10000
    infra-keep-probing: yes  # NEW: keep probing hosts that are down
    
    # local zones for tld blocking
    local-zone: "local." static
    local-zone: "localhost." static
    local-zone: "home." static
    local-zone: "lan." static
    local-zone: "internal." static
    local-zone: "corp." static
    local-zone: "private." static
    local-zone: "test." static
    local-zone: "invalid." static
    
    # additional rfc recommended zones
    local-zone: "onion." static
    local-zone: "home.arpa." static
    
    # bogus private reverse lookups (bogus-priv equivalent)
    local-zone: "10.in-addr.arpa." static
    local-zone: "16.172.in-addr.arpa." static
    local-zone: "17.172.in-addr.arpa." static
    local-zone: "18.172.in-addr.arpa." static
    local-zone: "19.172.in-addr.arpa." static
    local-zone: "20.172.in-addr.arpa." static
    local-zone: "21.172.in-addr.arpa." static
    local-zone: "22.172.in-addr.arpa." static
    local-zone: "23.172.in-addr.arpa." static
    local-zone: "24.172.in-addr.arpa." static
    local-zone: "25.172.in-addr.arpa." static
    local-zone: "26.172.in-addr.arpa." static
    local-zone: "27.172.in-addr.arpa." static
    local-zone: "28.172.in-addr.arpa." static
    local-zone: "29.172.in-addr.arpa." static
    local-zone: "30.172.in-addr.arpa." static
    local-zone: "31.172.in-addr.arpa." static
    local-zone: "168.192.in-addr.arpa." static
    
    # additional private reverse zones
    local-zone: "254.169.in-addr.arpa." static
    local-zone: "d.f.ip6.arpa." static
    local-zone: "8.e.f.ip6.arpa." static
    local-zone: "9.e.f.ip6.arpa." static
    local-zone: "a.e.f.ip6.arpa." static
    local-zone: "b.e.f.ip6.arpa." static
    
    # logging
    verbosity: 1
    use-syslog: yes
    log-queries: no
    log-replies: no
    log-servfail: yes  # NEW: log why queries return SERVFAIL
    log-local-actions: no
    
    # dns error codes
    ede: yes
    ede-serve-expired: yes

# forwarding zones for dnscrypt-proxy (configured upstream)
forward-zone:
    name: "."
    forward-addr: 127.0.0.1@54
    forward-addr: ::1@54
    forward-first: no

# disable remote control
remote-control:
    control-enable: no
